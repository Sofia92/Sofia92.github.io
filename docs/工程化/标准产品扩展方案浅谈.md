
# 背景

标准产品如何应对不同项目的需求差异，一般有两种方式：配置和扩展，这里主要讲产品扩展问题，这个问题一直存在于做产品研发的公司，控制好项目定制化的需求的研发成本，是影响产品在行业内的竞争力的重要因素之一。换言之，我们可以将标准产品的客户化能力看作产品研发的一个核心竞争力。医疗信息化发展相对滞后于其它行业的信息化发展，这里结合一下其它行业的产品扩展是如何做的，来阐述一下个人对产品扩展的一些想法。

# 产品扩展

## 字段级别的扩展

字段扩展这里建议两种方式：预留扩展字段和端到端动态扩展字段

### 预留扩展字段

预留扩展字段比较简单实用，就是从数据存储模型（数据库表）中预留一定数量的用于客户化的不同类型的字段，应用中的数据模型运行时也会有这些预留属性，当客户定制需求要增加业务字段时候，我们可以提供一个关联新增业务字段和预留字段关系的小工具，将这个映射关系作为扩展元数据维护起来，代码逻辑中依赖这个元数据就可以完成新增字段到预留字段的映射。

### 端到端动态扩展字段

从前端 view，到应用中数据模型，再到底层数据库表，可以端到端新增一个扩展字段称为端到端的字段扩展。实现起来相对复杂一些，首先我们在标准代码中要知道以后会在哪些表，哪些数据对象模型中新增字段，这就需要一个注册机制，在产品标准代码中将业务表、数据模型注册到字段扩展工具中来。数据库表动态增加字段可以简单实现，只要能知道表名；至于应用中的数据模型，我们可以在数据模型类中预留一个便于扩展的弱类型的 Map 结构用于扩展新字段属性。前端界面动态新增字段需要的信息，比如加在哪个区域，这些信息是需要通过字段扩展工具让客户化开发人员输入数据，前端代码中要增加一些额外处理扩展字段的逻辑。所以想要实现动态字段扩展，我们需要考虑以下几点：

1.  不是什么功能都可以动态扩展字段的，需要前后端代码需要按照扩展编程规范新增一些非业务的额外处理的代码才可以；
2.  需要一个扩展工具让客户化人员收集一些扩展元数据信息，这些信息会作为 1 中动态扩展字段的输入信息；
3.  动态扩展的功能需要提前注册好数据模型、数据库表信息，这样扩展工具才可以灵活的进行字段扩展；

## 流程级别的扩展

流程扩展这里提出两种方式：In-App 扩展和 Side-by-Side 扩展

### In-App 扩展

In-App 扩展就是指创建的扩展代码和被扩展的产品核心代码跑在一个应用进程内。一般项目上我们对产品的扩展，有两种方式：修改和增强。如果是修改，在标准产品版本升级后，就会丢失；如果是增强，产品考虑增强扩展后，在版本升级后，不会丢失。选择增强而不是修改也是遵循开闭设计原则的。

#### 增强技术

我们事先在标准产品程序里预留一些 Hook，项目定制开发人员可以实现这些 Hook，将自己的业务逻辑代码编写在里面。 这些 Hook 所在标准产品程序里的位置，称之为增强点。 当标准产品程序执行到这些 Hook 时，系统如果检测到有项目定制人员实现了这些 Hook，就调用之，从而实现了业务流程的扩展。通过这种在标准产品代码中埋入多个增强点的方式来扩展产品，是非常实用的，已经在其它行业具有复杂多变需求的产品研发中得到了验证。

关于增强点具体的技术实现方式，结合不同语言（比如前后端），可以通过标准产品内核动态或静态加载实现特定接口的类的插件来实现。C#和 AngularJS 中插件技术，可以基于去年（21 年）公共组件团队做的插件化开发技术来实现。

### Side-by-Side 扩展

Side-by-Side 扩展是指创建的扩展代码运行在标准产品应用的进程之外，甚至是核心应用服务器集群之外。这种扩展方式进入到微服务和云原生时代后，经常被使用到，在软件架构中，就类比 Sidecar 架构连接到父应用并且为其添加扩展或者增强功能，Sidecar 增强应用与主应用程序松散耦合，对于主应用是没有影响的。

#### Serverless 架构下的 FAAS 来实现客户增强

基于云原生和事件驱动技术，Side-by-Side 扩展的最好实现方式可能是 serverless 的 funtion as a service。我们的标准产品核心应用可以是微服务架构，而我们的扩展应用可以基于 serverless 架构来实现（每一个增强就是一个 function），通过核心应用中加入事件驱动，扩展应用订阅事件后，通过增强 function 服务来做到业务逻辑的扩展。

# 如何将产品扩展方案落地

## 研发扩展增强技术框架和工具

todo

## 制定产品扩展编程规范, 产品研发过程中要植入各种扩展点

todo
