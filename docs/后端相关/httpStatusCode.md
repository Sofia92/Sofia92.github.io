
# HTTP 状态码与错误处理

本章将介绍 API 应如何返回正确的 HTTP 状态码，及如何以统一规范的形式对错误进行处理。

## **MUST**  准确使用 HTTP 状态码反映 API 状态

开发人员必需**统一遵照 HTTP 规范语义来使用 HTTP 状态码，避免自行定义新的 HTTP 状态码**。

以下是当前 Web 开发中常用的 HTTP 状态码，开发人员应该学习并准确掌握其语义

### 成功 2xx

服务器顺利处理请求后，将会 2xx 形式的 HTTP 状态码：

| Code | Meaning                                                                                                                                                               | Methods                          |
| :--- | :-------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :------------------------------- |
| 200  | Success - 若服务器成功处理该请求，则返回该状态码                                                                                                                      | `<all>`                          |
| 201  | Created - 多在创建方法(POST)中使用，若请求的资源成功创建，则返回 201，同时响应体返回新创建的资源信息。另外**我们建议在响应头中带上 Location，里面包含新建资源的 URI** | `POST`, `PUT`                    |
| 202  | Accepted - 代表该请求已被服务器接受，同时该请求将被服务器异步处理                                                                                                     | `POST`, `PUT`, `PATCH`, `DELETE` |
| 204  | No content - 代表服务器成功处理该请求，且响应体为空。**建议在确实不需要返回信息的场景下多使用这个状态码，比如删除**                                                   | `PUT`, `PATCH`, `DELETE`         |

其中，值得注意的是：

- **如果请求出错，不能以 200 状态码返回**
- **尽量准确地使用返回码，例如创建资源时使用 201，异步请求使用 202，响应体为空使用 204**

### 跳转 3xx

| Code | Meaning                                                                                                          | Methods                          |
| :--- | :--------------------------------------------------------------------------------------------------------------- | :------------------------------- |
| 301  | Moved Permanently - 永久跳转，表示所有请求都将跳转到该新 URL（一般是针对搜索引擎），常见场景就是 HTTP 跳转 HTTPS | `<all>`                          |
| 302  | Found - 临时跳转，表示请求将临时跳转到 Location 指示的 URL 上（**业务中\*\***较为常用\*\*）                      | `POST`, `PUT`, `PATCH`, `DELETE` |
| 304  | Not Modified - 未修改，通过请求头 If-Modified-Since 与 If-None-Match 判断 Etag 缓存是否失效，详见                | `GET`                            |

### 请求错误 4xx

4xx 一般指代由用户请求引起的错误，如请求不符合服务器接口的要求。

在业务代码中，最为常用的错误码是 400、401、403、404。
| Code | Meaning |Methods|
| :--- | :--- | :--- |
|400|Bad request - 指代通用与未知错误，**建议在业务代码中请求验证失败以及业务流程中请求存在问题请返回此错误码**，基本上业务代码中多数情况会使用这个错误码。|`<all>`|
|401|Unauthorized - 其实语义更接近 "Unauthenticated"，**用户登录认证失败（如密码错误）应该返回该错误码**|`<all>`|
|403|Forbidden - 与 401 不同，403 多指代权限（Authorization）认证的错误，而不是身份认证（Authentication），因此**权限认证失败应该返回此错误码**|`<all>`|
|404|Not found - 未发现，表示资源未找到，**服务器找不到请求的资源时应该返回此错误码**|`<all>`|
|405|Method Not Allowed - 表明请求的 HTTP 方法该 URI 不支持|`<all>`|
|406|Not Acceptable - 无法根据内容协商请求头（如 Accept、Accept-Charset、Accept-Encoding）返回内容，则返回此错误码|`<all>`|
|408|Request timeout - 服务器处理请求超时|`<all>`|
|409|Conflict - 请求由于冲突无法完成，例如两个客户端同时请求幂等的 PUT 接口以更新资源，则由于存在并行冲突而导致其中一个请求失败|`POST`, `PUT`, `PATCH`, `DELETE`|
|415|Unsupported Media Type - 请求体的内容格式不被服务器接口支持（一般在请求体显式指定了内容格式的情况下会出现，比如上传）|`POST`, `PUT`, `PATCH`, `DELETE`|
|429|Too many requests - 请求次数过多，超过服务器限制|`<all>`|

### 服务器内部错误 5xx

5xx 一般指代由服务器本身引发的错误，如服务程序 BUG、依赖的组件服务出现故障等。
| Code | Meaning |Methods|
| :--- | :--- | :--- |
|500|Internal Server Error - 内部服务错误，**如果出现预期外的服务器异常建议使用这个错误码（开发时没有考虑到的程序 BUG 等），**一般出现这种错误，客户端可以考虑重试请求。|`<all>`|
|503|Service Unavailable - 服务暂时不可用，在服务整体维护时也可以返回这个错误码。出现这种错误时，客户端可以考虑重试请求|`<all>`|

## **MUST** API 采用统一的错误返回格式

出于运维监控的需要，**公司项目服务必需采用统一的 API 错误响应体格式**。

架构组基于 EMR 和 BANK 开发组在错误处理方面的积累，通过统一的库 `Synyi.Api.Exceptions` 规范异常的响应体格式，开发者在注入 Synyi.Api.Exceptions 提供的 Filter 之后，即可以通过在业务代码抛出提供的异常来返回规范的错误体。

下面是错误返回格式的示例（具体的 Schema 请参考）：

```Json
{
 "code": "400100",                                             // 内部错误码，在 HTTP 状态码的基础上，对于具体的错误场景进行细分
 "status": "INVALID_PARAMETER",                                // 内部错误类型名称，与内部错误码相对应
 "message": "无效参数",                                         // 对于当前错误的文本描述，可以是中文，但必须 UTF-8 编码
 "details": [                                                 //（可选）当前错误的详细信息，类型为数组，元素对内容根据错误类型不同而有所变化
  {"field": "username", reason: "username is required"}
 ]
}
```

其中

- code - 内部错误码，在 HTTP 状态码的基础上，对于具体的错误场景进行细分。
- status -    内部错误类型，公司统一规范的错误类型名称，与内部错误码相对应。
- message - 对于当前错误的具体文本描述，可以是中文，如有业务需要时开发人员可以自定义需要输出的 Message （指定抛出异常的参数）
- details - （可选）当前错误的详细信息，类型为数组，元素对内容根据错误类型不同而有所变化，可以通过前后端协商进行约定

以下是规定的公司内部错误码与错误类型名称：

| HTTP Code | Internal Code | Status                | Message          | Comment                                                                                                                                         |
| :-------- | :------------ | :-------------------- | :--------------- | :---------------------------------------------------------------------------------------------------------------------------------------------- |
| 400       | 400000        | BAD_REQUEST           | 请求异常         | 异常的请求，代表通用的 400 错误                                                                                                                 |
| 400       | 400100        | INVALID_PARAMETER     | 无效参数         | 请求体中的参数存在异常（长度过长、类型错误等），具体情况可以在 Details 中描述，说明异常的字段名称与具体错误类型                                 |
| 400       | 400101        | MISSING_PARAMETER     | 遗漏参数         | 请求体遗漏了接口要求必需的参数，具体情况可以在 Details 中描述                                                                                   |
| 400       | 400200        | CONSTRAINT_VIOLATION  | 请求违反业务约束 | 请求提交表单字段不满足业务需求，违反了业务规定的约束（如新用户的密码必须带大小写与数字），具体情况可以在 Details 中描述说明有问题的字段以及原因 |
| 400       | 400300        | DUPLICATE_REQUEST     | 重复请求         | 服务器发现请求已经提交过，或者接口资源有唯一性(unique) 的要求，或接口不保证幂等性因此拒绝该请求                                                 |
| 400       | 400301        | ALREADY_EXISTED       | 资源已存在       | 在创建资源时，发现资源已经上传/创建，因此拒绝该请求                                                                                             |
| 401       | 401000        | UNAUTHENTICATED       | 身份验证失败     | 身份验证(Authentication) 失败，代表通用的 401 错误                                                                                              |
| 401       | 401001        | WRONG_PASSWORD        | 密码错误         | 由于密码错误导致的身份验证失败                                                                                                                  |
| 401       | 401002        | WRONG_USERPASS        | 用户或密码错误   | 由于用户名或密码错误导致的身份验证失败                                                                                                          |
| 403       | 403000        | FORBIDDEN             | 权限认证失败     | 权限认证（Authorization）失败，代表通用的 403 错误                                                                                              |
| 404       | 404000        | NOT_FOUND             | 未找到           | 找不到请求的资源，代表通用的 404 错误                                                                                                           |
| 404       | 404100        | TENANT_NOT_FOUND      | 租户未找到       | 未找到请求的租户                                                                                                                                |
| 500       | 500000        | INTERNAL_SERVER_ERROR | 内部服务错误     | 代表通用的 500 错误，可能是代码抛出了未被处理的异常，**注意生产环境中不应该在 details 中返回异常的 Stack Trace 信息（开发环境中可以）**         |
| 500       | 500001        | INVALID_DATA          | 数据格式非法     | 在程序运行过程中发现使用的数据（一般来自数据库）不符合业务要求的格式                                                                            |
| 500       | 500100        | EXTERNAL_UNAVAILABLE  | 外部服务不可用   | 代表依赖的外部服务不可用（如 NLP、第三方 API 等），可以在 details 中说明调用服务返回的错误码与错误信息                                          |
| 500       | 500200        | RPC_FAILED            | 远程过程调用失败 | 内部 RPC 调用微服务失败，可以在 details 中返回调用链以及被调服务的错误码与错误信息                                                              |
| 500       | 500300        | DATABASE_UNAVAILABLE  | 数据库不可用     | 依赖的数据库不可用，可以在 details 中返回故障原因                                                                                               |
| 500       | 500301        | DATABASE_TIMEOUT      | 数据库连接超时   | 数据库连接超时                                                                                                                                  |
| 500       | 500400        | MESSAGE_QUEUE_ERROR   | 消息队列错误     | 消息队列出现异常或不可用，在处理异步请求时如果出错可以考虑返回此错误                                                                            |
| 500       | 500500        | CACHE_UNAVAILABLE     | 缓存不可用       | 依赖的缓存服务不可用（如 Redis）                                                                                                                |
| 503       | 503000        | SERVICE_UNAVAILABLE   | 服务不可用       | 代表通用的 503 错误                                                                                                                             |
| 503       | 503001        | UNDER_MAINTENANCE     | 服务维护中       | 表示当前服务正在维护中                                                                                                                          |
