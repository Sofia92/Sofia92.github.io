---
title: 中山项目界面卡顿问题排查过程
category: TroubleShooting
tags:
  - 系统卡顿
  - 问题解决
---

# 中山项目界面卡顿问题排查过程

中山项目多次用户反馈界面卡顿的性能问题，严重影响用户体验。

本文基于实际问题排查案例进行性能问题排查与解决方法的小结。

## 中山项目真实案例

- 患者床位卡列表在数据量达到 70 人以上时有明显卡顿（约 5s 才显示出列表）
- 患者医嘱列表，ICU 每天执行几十条医嘱，一周后产生上千条医嘱，界面加载非常慢（约 1 分钟才显示出列表）
- 出院患者病案首页来回切换，长时间使用后界面严重卡顿，甚至浏览器无响应
- 病案编码界面，长时间使用后双击文字选中时卡顿，诊断编码选中项目时有明显延迟

## 排查定位思路与数据收集

定位现场提出的卡顿问题可大致从以下三个方面来思考：

1.  硬件设备配置的限制
2.  巨大的数据量基数
3.  优化不足的业务代码/算法

结合这三个方面，如果本地难以复现，我们需要收集一些现场的信息辅助问题的排查。

### 硬件资源

硬件资源的限制是硬伤，比如内存小，CPU 不足等等。

性能问题是否是因用户内存/CPU 配置过低，可通过系统设置（对于 windows 的用户）进行排查。

性能问题是否是因用户内存/CPU 占用过高，可以通过任务管理器（对于 windows 的用户）进行排查。

> 此时需要在开发者工具的 Memory 中顺带收集 EMR 的内存占用信息。对于 EMR 而言，页面内存占用超过 500MB 需要警惕是否存在内存泄露，具体排查与解决放在业务代码/算法内。

### 数据量

数据量带来的性能压力往往不会出现在项目的起步阶段，而是出现在上线后的具体业务场景下。

性能问题是否由数据量造成，可根据实际的业务数据来得出有效结论。

> 此时需要收集用户的场景路径，即如何进入此具有带有大量数据的界面，以便大数据量复现。 对于 EMR 而言，简单列表显示 300 条数据以上，复杂列表显示 50 条数据以上应当考虑是否是因为需要显示的数据过多造成。 即使表面呈现的数据量不多，也需要考虑后端实际查询的数据量。因此此时需要收集接口响应时间相关数据，若接口明显较慢（超过 500ms），则需要收集请求参数，复制 curl，用于后端性能问题排查。

### 业务代码/算法

业务代码/算法（时间/空间复杂度、重复/无用计算带来的过大常数）是性能问题的最后一关，也是最难排查的一关。一般在解决了前两者的性能压力后或排查发现不是前两者的问题再考虑。

> 此时需要收集用户使用卡顿场景下的 performance profile。在开发者工具的`Performance`中录制一段带有内存记录的 profile，并导出 JSON，用于前端性能问题排查。

## 解决思路

### 硬件资源

#### 配置不足类问题

如果有无穷大的内存，有无穷算力的处理器，那么几乎所有的性能问题将不是问题，即使内存大量泄露，即使业务代码嵌套了很多无用的循环。

在一些硬件配置过低的场景下，建议用户升级硬件也是解决此类性能问题的一种办法。一些业务场景的复杂度导致前端页面必须要在有足够优秀的硬件的设备上才能正常工作，为了提升少数低配设备上的体验而去花时间做极致的优化有些得不偿失。

> 对于 EMR 而言，8G 及以上的内存，1.5GHz 以上的 CPU 主频是合理的配置。低于此配置造成体验不佳应当考虑让用户升级硬件，而非做性能优化。

#### 占用过高

在合理的硬件配置下，仍有可能是其他应用程序内存占用过高导致剩余可分配的硬件资源不足。如果用户剩余可用硬件资源不多（内存/CPU 占用达到 90%以上），并且其他程序也在用户日常正常使用范围内，则建议是升级硬件，或排查其他应用程序的性能问题。

### 数据量

对实际场景下某个页面需要显示/处理的数据量进行一个合理的预估，是在产品设计的前期需要做的一个工作。若定位到性能问题是由于数据量，则必须从产品设计层面来解决。

解决思路主要分两种：

1.  分次加载（减少一次加载的数据量）
2.  简化展示内容（减少每条数据需要消耗的资源）

分次加载的解决方案有分页、懒加载、部分加载。

#### 分次加载

分页加载：数据支持分页查询，界面呈现添加分页控件或滚动加载下一页。一般而言，滚动加载下一页的方案需要确保列表内容不能经常被修改，否则容易出现列表内容不一致的 bug，而使用分页控件则不需要过于担心，因为用户不能同时看到其他页的内容。

懒加载：数据一次查询，界面呈现时分批次加载，按需加载。适用于后端数据查询不好改造的场景。

部分加载：参考虚拟滚动。

#### 简化内容

简化展示内容一般需要砍掉一些业务逻辑或改变显示内容的形式，通常不会被产品经理采纳，需要研发测 argue 来争取。

对于后端，可以减少关联查询的信息，仅查询必要的信息。

常见前端简化内容：

图标 svg -> 纯文字/图片 tooltip 组件 -> HTMLElement.title 属性 表格输入控件 -> 点击后懒创建 去掉一些过渡动画/交互效果

### 业务代码/算法

此类问题需要阅读业务代码，分析算法的时间复杂度，并结合具体场景的业务数据量来大致分析执行耗时，从而定位问题。

常见前端问题代码定位方法：

1.  使用二分查找法，注释掉可能有问题的代码，根据性能表现来定位有性能问题的代码。
2.  使用`console.time`与`console.timeEnd`统计业务逻辑函数的执行时间，适用于 1 中注释会打乱业务逻辑的情况。
3.  从 profile 中找到执行时间长的函数，增加断点，根据调用栈定位相应业务代码，适用于 2 中业务代码难以大致定位的情况。

后端问题代码排查方法待补充。

## 案例详细

最终问题的解决方法需要具体问题具体分析。下面列举一些中山项目的实际案例供参考：

### 患者床位卡列表

初步排查：硬件设备无殊，后端接口在 280 个患者的数据量下需要 4s 响应，存在性能问题。前端代码渲染耗时则需要 15s 左右，也存在性能问题。

进一步排查：后端内存操作过多，前端床位卡展示元素很多

问题定位：数据量大。

优化方案：后端接口改造，前端滚动懒加载。

### 患者医嘱列表

初步排查：硬件设备无殊，后端接口 200ms 以内，前端渲染 20s，主要瓶颈在前端。

进一步排查：

前端渲染元素非常多：$$('\*').length 约 10 万

业务代码存在冗余逻辑：

开立权限计算对仅展示的临时医嘱列表无实际意义，并且在循环内读取配置频繁调用 localStorage.get 与 JSON.parse 读取大 JSON 权限配置

重复了一次脏检查（loading 改变）

问题定位： 数据量大+业务代码。

优化方案：前端滚动懒加载（产品决策为向上滚动加载而非向下滚动加载），并移除冗余逻辑。

### 病案编码卡顿

初步排查：硬件设备无殊，后端无接口调用，前端在双击选中时 profile 显示 angular 执行了重渲染，约 200ms。

进一步排查：一个挂在 document 上的 mouseup 事件处理器触发重渲染，经二分查找+断点看调用栈确定事件为编辑器在初始化时添加。

排查使用代码：

```
// 执行必须在其他脚本执行之前，放在script内
(() => {
  /**
   * @template T
   * @param {T} target
   * @param {keyof T} key
   * @param {(a: unknown[], s: T) => void} hook
   */
  function wrap(target, key, hook) {
    const original = target[key];
    Object.defineProperty(target, key, {
      value(...args) {
        hook(args, this);
        return original.apply(this, args);
      }
    })
  }
  const targetSet = new Set();
  window.st = targetSet;
  // 给EventTarget原型上的addEventListener方法添加hook
  wrap(EventTarget.prototype, "addEventListener", ([event, listener], self) => {
    if (event === "mouseup") {
      debugger
      console.log(listener, self);
      // 输出调用栈
      console.log(new Error().stack)
      targetSet.add(listener);
      targetSet.add(self);
    }
  });
})();
```

问题定位：业务代码。

优化方案：将编辑器初始化代码放到 NgZone 外部执行。
